<!-- src/main/resources/templates/events/list.html -->
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events - CoWalking</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<header>
    <nav>
        <div class="nav-container">
            <a href="/" class="logo">CoWalking</a>
            <ul class="nav-menu">
                <li><a href="/events">Events</a></li>
                <!-- <li><a href="/locations">Locations</a></li> --> <!-- Пока оставим, если планируется реализация -->
                <!-- --- ЗАМЕНЯЕМ Spring Security проверки на JS --- -->
                <li id="profileNav" style="display:none;"><a href="/users/profile" id="profileLink">Profile</a></li>
                <li id="logoutNav" style="display:none;">
                    <button id="logoutBtn" onclick="simulateLogout()">Logout</button>
                </li>
                <li id="loginNav"><a href="/login">Login</a></li>
                <li id="registrationNav"><a href="/registration">Register</a></li>
                <!-- --- КОНЕЦ ЗАМЕНЫ --- -->
            </ul>
        </div>
    </nav>
</header>

<main>
    <div class="container">
        <h1>Events</h1>

        <!-- --- ЗАМЕНЯЕМ Spring Security проверки на JS --- -->
        <div id="createEventDiv" style="display:none;">
            <a href="/events/create" class="btn-primary">Create Event</a>
        </div>
        <button id="loginToCreateBtn" class="btn-primary" style="display:none;" onclick="checkAuthForAction('Create Event');">Create Event</button>
        <!-- --- КОНЕЦ ЗАМЕНЫ --- -->

        <div class="events-grid">
            <div class="event-card" th:each="event : ${events}">
                <h3 th:text="${event.title}">Event Title</h3>
                <p th:text="${event.description}">Event Description</p>
                <p>Location: <span th:text="${event.location.name}">Location Name</span></p>
                <p>Time: <span th:text="${#temporals.format(event.startTime, 'dd/MM/yyyy HH:mm')}">Start Time</span></p>
                <p>Participants: <span th:text="${event.currentParticipants} + '/' + ${event.maxParticipants ?: 'Unlimited'}">Participants</span></p>
                <a th:href="@{/events/{id}(id=${event.id})}" class="btn-secondary">View Details</a>

                <!-- --- ЗАМЕНЯЕМ Spring Security проверки на JS --- -->
                <button class="join-event-btn" data-event-id="${event.id}" style="display:none;" onclick="handleJoinEvent(this.getAttribute('data-event-id'));">Join Event</button>
                <button class="leave-event-btn" data-event-id="${event.id}" style="display:none;" onclick="handleLeaveEvent(this.getAttribute('data-event-id'));">Leave Event</button>
                <button class="edit-event-btn" data-event-id="${event.id}" style="display:none;" onclick="handleEditEvent(this.getAttribute('data-event-id'));">Edit Event</button>
                <button class="delete-event-btn" data-event-id="${event.id}" style="display:none;" onclick="handleDeleteEvent(this.getAttribute('data-event-id'));">Delete Event</button>
                <!-- --- КОНЕЦ ЗАМЕНЫ --- -->
            </div>
        </div>
    </div>
</main>

<!-- --- ДОБАВЛЕННЫЙ JS для имитации аутентификации и действий --- -->
<script th:inline="javascript">
    // --- Проверка аутентификации и обновление UI при загрузке ---
    window.onload = function() {
        const isAuthenticated = localStorage.getItem('isAuthenticated') === 'true';
        const currentUser = localStorage.getItem('currentUser');
        const userRole = localStorage.getItem('userRole');

        if (isAuthenticated && currentUser) {
            document.getElementById('profileLink').textContent = currentUser;
            document.getElementById('profileNav').style.display = '';
            document.getElementById('logoutNav').style.display = '';
            document.getElementById('loginNav').style.display = 'none';
            document.getElementById('registrationNav').style.display = 'none';

            // Показываем кнопку "Create Event"
            document.getElementById('createEventDiv').style.display = '';
            document.getElementById('loginToCreateBtn').style.display = 'none';

            // Показываем кнопки Join/Leave/Edit/Delete в зависимости от роли/владения
            document.querySelectorAll('.event-card').forEach(card => {
                const joinBtn = card.querySelector('.join-event-btn');
                const leaveBtn = card.querySelector('.leave-event-btn');
                const editBtn = card.querySelector('.edit-event-btn');
                const deleteBtn = card.querySelector('.delete-event-btn');

                // Для простоты, покажем Join/Leave всем аутентифицированным
                joinBtn.style.display = '';
                leaveBtn.style.display = '';

                // Покажем Edit/Delete только "организатору" (в реальности это проверяется бы на бэкенде)
                // В данной имитации, предположим, что пользователь "admin" может всё
                if (currentUser === 'admin') { // Проверка имени, а не роли, для простоты
                     editBtn.style.display = '';
                     deleteBtn.style.display = '';
                }
            });

            if (userRole === 'ADMIN') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = '');
            }
        } else {
            document.getElementById('profileNav').style.display = 'none';
            document.getElementById('logoutNav').style.display = 'none';
            document.getElementById('loginNav').style.display = '';
            document.getElementById('registrationNav').style.display = '';

            // Показываем кнопку "Login to Create Event"
            document.getElementById('createEventDiv').style.display = 'none';
            document.getElementById('loginToCreateBtn').style.display = '';

            // Скрываем кнопки Join/Leave/Edit/Delete
            document.querySelectorAll('.join-event-btn').forEach(btn => btn.style.display = 'none');
            document.querySelectorAll('.leave-event-btn').forEach(btn => btn.style.display = 'none');
            document.querySelectorAll('.edit-event-btn').forEach(btn => btn.style.display = 'none');
            document.querySelectorAll('.delete-event-btn').forEach(btn => btn.style.display = 'none');

            // Скрываем админские элементы
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
        }
    };

    function simulateLogin(username, role = 'USER') {
        localStorage.setItem('isAuthenticated', 'true');
        localStorage.setItem('currentUser', username);
        localStorage.setItem('userRole', role);
        location.reload();
    }

    function simulateLogout() {
        localStorage.removeItem('isAuthenticated');
        localStorage.removeItem('currentUser');
        localStorage.removeItem('userRole');
        location.reload();
    }

    function checkAuthForAction(actionName) {
        if (localStorage.getItem('isAuthenticated') !== 'true') {
            alert(`Please log in to ${actionName.toLowerCase()}.`);
            window.location.href = '/login';
            return false;
        }
        return true;
    }

    // --- ИМИТАЦИЯ действий ---
    function handleJoinEvent(eventId) {
        if (!checkAuthForAction('Join Event')) return;
        alert(`Simulating joining event ${eventId}`);
        // Здесь мог бы быть fetch('/participations/join/' + eventId, {method: 'POST', ...})
    }

    function handleLeaveEvent(eventId) {
        if (!checkAuthForAction('Leave Event')) return;
        alert(`Simulating leaving event ${eventId}`);
        // fetch('/participations/leave/' + eventId, {method: 'POST', ...})
    }

    function handleEditEvent(eventId) {
        if (!checkAuthForAction('Edit Event')) return;
        window.location.href = `/events/${eventId}/edit`;
    }

    function handleDeleteEvent(eventId) {
        if (!checkAuthForAction('Delete Event')) return;
        if (confirm('Are you sure you want to delete this event?')) {
            alert(`Simulating deleting event ${eventId}`);
            // fetch('/events/' + eventId + '/delete', {method: 'POST', ...})
        }
    }
    // --- КОНЕЦ ИМИТАЦИИ ---
</script>
<!-- --- КОНЕЦ ДОБАВЛЕННОГО JS --- -->
</body>
</html>